<!doctype html>
<html lang="en"> 
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
		<meta http-equiv="Pragma" content="no-cache" />
		<meta http-equiv="Expires" content="0" />
		<title>Online Paint</title>

		<script src="https://code.jquery.com/jquery-3.6.1.slim.min.js" integrity="sha256-w8CvhFs7iHNVUtnSP0YKEg00p9Ih13rlL9zGqvLdePA=" crossorigin="anonymous"></script>
		<script src="https://cdn.socket.io/4.5.4/socket.io.min.js" integrity="sha384-/KNQL8Nu5gCHLqwqfQjA689Hhoqgi2S84SNUxC3roTe4EhJ9AfLkp8QiQcU8AMzI" crossorigin="anonymous"></script>
		<script type="text/javascript">

			function drawLine(x1, y1, x2, y2, color) {
				if (x1 == -1 || y1 == -1) {
					socket.emit('message', {x2, y2, color});
					return
				}

				const line = [];
				// Create an array to store the points
				const dx = Math.abs(x2 - x1);
				const dy = Math.abs(y2 - y1);

				// Calculate the error value
				let error = dx - dy;

				// Create a variable to store the direction of the line
				let xstep, ystep;

				// Check which direction the line is going in
				if (x1 < x2) {
					xstep = 1;
				} else {
					xstep = -1;
				}
				if (y1 < y2) {
					ystep = 1;
				} else {
					ystep = -1;
				}

				// Loop through the points on the line
				while (true) {
					// Add the current point to the line
					line.push({x: x1, y: y1});

					// Check if we have reached the end point
					if (x1 === x2 && y1 === y2) {
						break;
					}

					// Calculate the new error value
					const error2 = 2 * error;

					// Check if we need to move in the x or y direction
					if (error2 > -dy) {
						error -= dy;
						x1 += xstep;
					}
					if (error2 < dx) {
						error += dx;
						y1 += ystep;
					}
				}

				socket.emit('line', {line: JSON.stringify(line), color})

				// line.forEach(({x,y}) => socket.emit('message', {x, y, color}))
			}
	
			var socket;

			$(function(){
				let loading = true;
				let dim = 0;
				let color = 'A';
				let prevX = -1;
				let prevY = -1;

				function getRGB(c) {
					switch (c) {
						case 'A':
							return 'rgb(0, 0, 0)';			//black
						case 'B':
							return 'rgb(128, 128, 128)';	//gray
						case 'C':
							return 'rgb(192, 192, 192)';	//silver
						case 'D':
							return 'rgb(128, 0, 0)';		//maroon
						case 'E':
							return 'rgb(255, 0, 0)';		//red
						case 'F':
							return 'rgb(128, 128, 0)';		//olive
						case 'G':
							return 'rgb(255, 255, 0)';		//yellow
						case 'H':
							return 'rgb(0, 128, 0)';		//green
						case 'I':
							return 'rgb(0, 255, 0)';		//lime
						case 'J':
							return 'rgb(0, 128, 128)';		//teal
						case 'K':
							return 'rgb(0, 255, 255)';		//aqua
						case 'L':
							return 'rgb(0, 0, 128)';		//navy
						case 'M':
							return 'rgb(0, 0, 255)';		//blue
						case 'N':
							return 'rgb(128, 0, 128)';		//purple
						case 'O':
							return 'rgb(255, 0, 255)';		//fuchsia
						case 'P':
							return 'rgb(255, 255, 255)';	//white
					}
				}

				socket = io();
				socket.on('open', 
					function(event) {
						$('#sendButton').removeAttr('disabled');
						console.log("connected");
					}
				);
				socket.on('close', 
					function(event) {
						alert("closed code:" + event.code + " reason:" +event.reason + " wasClean:"+event.wasClean);
					}
				);
				socket.on('message', 
					function(e) {
						console.log(e);
						const context = document.getElementById('canvas').getContext('2d');
						// on initial message from server
						if(e.x == -1 && e.y == -1){
							// server sets dimensions
							dim = e.dim; 
							document.getElementById("canvas").width = dim;
							document.getElementById("canvas").height = dim;

							// fill colour with default colour
							for(let i = 0; i < e.color.length; i++){
								context.fillStyle =  getRGB(e.color.charAt(i));
								context.fillRect(i/dim, i%dim, 1, 1);
							}

							// remove loading sign
							loading = false;
							document.getElementById("loadingMsg").style.display = "none";
						} else {
							context.fillStyle = getRGB(e.color);
							context.fillRect(e.x, e.y, 1, 1);
						}
					}
				);

				var mouseDown = false;

				$('#canvas').mousedown(function(event){
					if (!loading) {
						mouseDown = true;
					}
				})

				$('#canvas').mouseup(function(event){
					if (!loading) {
						mouseDown = false;
					}
					prevX = -1;
					prevY = -1;
				})

				$('#canvas').mousemove(function(event){
					if (!loading && mouseDown) {
						var x=event.pageX-this.offsetLeft;
						var y=event.pageY-this.offsetTop;
						drawLine(prevX, prevY, x, y, color);
						prevX = x;
						prevY = y;
					}
				});

				$('#canvas').click(function(event){
					if (!loading) {
						var x=event.pageX-this.offsetLeft;
						var y=event.pageY-this.offsetTop;
						var o = { 
							'x': x, 
							'y': y, 
							'color' : color
						};
						socket.emit('message', o);
					}
				})

				$('#clearButton').submit(function( event ) {
					var o = {
						'clearBoard' : true
					};
					socket.emit('message', o);
					event.preventDefault();
				});

				$(document).ready(function() {
					// var user = "none";
					$(".color").click(function() {
					color = $(this).attr("data-name");
					});

					$("#test").click(function() {
					alert(color);
					});
				});
			});
		</script>
		<style>
			body {
				text-align: center;
				align: center;
				margin: 0px;
				padding: 0px;
			}
			canvas {
				border: 1px solid black;
			}
			input[type=number]{ width: 3em; }
		</style>
	</head>
	<body>
		<h1>Online Paint</h1>
		
		<h2 id="loadingMsg"> LOADING CANVAS... PLEASE WAIT</h2>
		<canvas id="canvas" width="250" height="250" ></canvas>
		<div id="game">
			<button class="color" data-name="A" style="background-color: rgb(0,0,0); height: 30px; width: 30px;"></button>
			<button class="color" data-name="B" style="background-color: rgb(128,128,128); height: 30px; width: 30px;"></button>
			<button class="color" data-name="C" style="background-color: rgb(192,192,192); height: 30px; width: 30px;"></button>
			<button class="color" data-name="D" style="background-color: rgb(128, 0, 0); height: 30px; width: 30px;"></button>
			<button class="color" data-name="E" style="background-color: rgb(255, 0, 0); height: 30px; width: 30px;"></button>
			<button class="color" data-name="F" style="background-color: rgb(128, 128, 0); height: 30px; width: 30px;"></button>
			<button class="color" data-name="G" style="background-color: rgb(255, 255, 0); height: 30px; width: 30px;"></button>
			<button class="color" data-name="H" style="background-color: rgb(0, 128, 0); height: 30px; width: 30px;"></button>
			<button class="color" data-name="I" style="background-color: rgb(0, 255, 0); height: 30px; width: 30px;"></button>
			<button class="color" data-name="J" style="background-color: rgb(0, 128, 128); height: 30px; width: 30px;"></button>
			<button class="color" data-name="K" style="background-color: rgb(0, 255, 255); height: 30px; width: 30px;"></button>
			<button class="color" data-name="L" style="background-color: rgb(0, 0, 128); height: 30px; width: 30px;"></button>
			<button class="color" data-name="M" style="background-color: rgb(0, 0, 255); height: 30px; width: 30px;"></button>
			<button class="color" data-name="N" style="background-color: rgb(128, 0, 128); height: 30px; width: 30px;"></button>
			<button class="color" data-name="O" style="background-color: rgb(255, 0, 255); height: 30px; width: 30px;"></button>
			<button class="color" data-name="P" style="background-color: rgb(255, 255, 255); height: 30px; width: 30px;"></button>
		</div>
		<form id="clearButton">
			<input type="submit" name="clear" value="clear"/>
	</form>
	</body>
</html>

